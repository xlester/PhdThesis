\chapter{Regularized self-tuning phase demodulation for phase-shifting
interferometry with arbitrary phase shifts}

In this chapter, we develop a regularization technique to demodulate
a phase-shifting interferogram sequence with arbitrary inter-frame
phase shifts. With this method, we can recover the modulating phase
and inter-frame phase shifts in the same process. As all phase-shifting
algorithms, the assumption is that the wavefront under test does not
change over time but the phase-shifting introduction can vary in a
non constant way. A notable characteristic of this demodulation method
is that it not only can recover the modulating phase, but also it
is capable of filtering-out large quantities of corrupting noise.
We will show numerical experimental results and comparisons with other
already published method to see the performance of the herein developed
demodulation technique.

\section{Introduction}

Nowadays, Phase Shifting Interferometry (PSI) techniques are one of
the most used techniques in optical metrology \cite{Malacara}. In PSI, one
obtains an small sequence of at least 3 interferograms with a phase-shifting
among them {[}1{]}. To recover the modulating phase there are standard
demodulation PSI methods; the well known 3-, 4-, and 5-steps phase-shifting
algorithms. Knowing the inter-frame phase-shifts (or temporal carrier)
the standard methods recover the modulus 2$\pi$ phase map with the
minimum possible error \cite{Malacara,Freischlad:90,Servin:09}. If we
do not know the phase-shifts exactly, we obtain a phase map with an
unavoidable detuning error whose magnitude depends on the number of
interferograms employed and how far we are from the actual phase-shifts
\cite{Servin:09,Schwider:83,Ai:87,Larkin:01,Langoju:06}. This unfortunate case
can occur when the optical
interferometer setup is uncalibrated or perturbations from the environment
affect the interferometer\textquoteright{}s optical path. For example,
for most phase shifters such as a piezoelectric there is a repeatability 
problem from hysteresis, non linearity, and temperature linear drift
\cite{Ai:87,Cheng:85}.
Curiously, first phase-shifting algorithms where self-tuning nonlinear
algorithms. Other approaches, propose error compensating
algorithms to reduce detuning errors that basically use redundant
data such as the Schwider-Hariharan 5-steps algorithm
\cite{Schwider:83,Hariharan:87,Surrel:93},
and more recently by constructing a wide-band frequency response of
the phase-shifting algorithm as the 7-steps algorithm shown in
\cite{Estrada:09}.
Further methods use the Fourier transform in order to estimate the
inter-frame phase-shifts \cite{Larkin:01,Lai:91}, and other are based on the
least-squares scheme estimating iteratively the inter-frame phase-shifts
and phase \cite{Kong,Wang:04}.

What we are going to show in this chapter, is a regularized self-tuning
demodulation technique that obtains the analytical image (complex
interferogram) and inter-frame phase-shifts from an interferogram
sequence. Thus, we can recover the modulating phase modulus 2$\pi$
and the inter-frame phase shifts in the same process. Here, it is
not necessary to know the inter-frame phase-shifts. This inter-frame
phase-shifts can vary arbitrary. The main difference between the demodulation
method presented here, and the reported in \cite{Kong,Wang:04,Larkin:02}, is
that the herein demodulation method is based on a regularization technique
that is able to remove noise from its input and is robust to non constant
modulation variations, which is an issue that introduce errors in
methods of works \cite{Kong,Wang:04}. Besides, we do not require estimate
the fringe orientation as the method of work \cite{Larkin:02}.


\section{Regularized self-tuning method}

In general, an interferogram sequence with arbitrary inter-frame phase-shifts
can be modeled as 
\begin{equation}
I_{k}(x,y)=a(x,y)+b(x,y)cos(\phi(x,y)+\alpha_{k}),\; k=0,1,2,...,N-1,\label{eq:
Ik}
\end{equation}
where $I_{k}(x,y)$ is the intensity at the site $(x,y)$ of the
\emph{k}-interferogram in a sequence of $N-1$ interferograms, being
$a(x,y)$ its background illumination, $b(x,y)$ its contrast or modulation,
$\phi(x,y)$ the modulating phase under test and $\alpha_{k}$ the
phase-shifting of the \emph{k}-interferogram. We can remove the background
illumination of each interferogram in the following way: 
\begin{equation}
I_{k}^{'}(x,y)=I_{k}(x,y)-[I_{k}*h](x,y),\; k=0,1,2,...,N-1,\label{eq:I'}
\end{equation}
where $h(x,y)$ is the impulse response of a low-pass filter such
as a Gaussian or mean filter and \textasteriskcentered{} is the convolution
operator \cite{Jahne}. Making this, the new interferogram sequence looks
like 
\begin{equation}
I_{k}^{'}(x,y)=b^{'}(x,y)cos(\phi(x,y)+\alpha_{k}),\: k=0,1,2,...,N-1.\label{eq:
I'2}
\end{equation}
The main idea of the regularized self-tuning demodulation method that
we show here comes from the article of Marroquin et al. \cite{RQF}.
The demodulation process presented by Marroquin et al., minimizes
a nonlinear system that estimates the complex field of the first interferogram
and its local spatial frequencies. We, unlike the Marroquin et al.
work, estimate the inter-frame phase-shifts from the interferogram
sequence. Therefore, our demodulation method minimizes the following
quadratic functional
\begin{eqnarray}
U(f,\alpha) & = & \sum_{(x,y)}(\varphi(x,y)-I_{0}^{'}(x,y))^{2}\nonumber \\
& &+\sum_{k=1}^{N-1}
\sum_{(x,y)}[\frac{1}{2}[f(x,y)e^{i\alpha_{k}}+f^{*}(x,y)e^{-i\alpha_{k}}]-I_{k}
^{'}(x,y)]^{2}\label{eq:U}\\
 &  & +\lambda\sum_{(x,y)}[||D_{x}[f(x,y)]||^{2}+||D_{y}[f(x,y)]||^{2}],\nonumber 
\end{eqnarray}
where $f=\left\{ f(x,y)=\varphi(x,y)+i\psi(x,y):(x,y)\in L\right\} $
is the complex field, $i=\sqrt{-1}$, and $f^{*}$ its complex conjugated.
The sums with the notation $(x,y)$ underneath, runs over all valid
sites $(x,y)$ of the interferograms. Operators $D_{x}[]$ and $D_{y}[]$
takes the first order differences along $x$ and $y$ direction, as
follows:
\begin{equation}
D_{x}[f(x,y)]=f(x,y)-f(x-1,y)+f(x,y)-f(x+1,y),
\end{equation}
\begin{equation}
D_{y}[f(x,y)]=f(x,y)-f(x,y-1)+f(x,y)-f(x,y+1).
\end{equation}
The regularization parameter $\lambda$ controls the smoothness of
the complex field \cite{RQF,AQF_mult}. The first and second terms are
the data terms, and the third term is the regularization term. Our
reference is the first interferogram, therefore, we consider that
its phase-shifting is $\alpha_{0}=0$. This is the reason of the first
data term, which results when $k=0$, and therefore, the second data
term starts in $k=1$. The minimization process of the functional
(3.4) leads to a robust to noise nonlinear phase-shifting algorithm
of N-steps that can recover the modulating phase and inter-frame phase
shifts. With the complex field $\widehat{f}$ and phase-shifts $\alpha$
that minimize (3.4), the modulating phase is recovered as 
\begin{equation}
\phi(x,y)=arg[\widehat{f}(x,y)]=arctan\left[\frac{\hat{\psi}(x,y)}{\widehat{
\varphi}(x,y)}\right].\label{eq:fi}
\end{equation}
The minimization of functional (3.4), turns us to a nonlinear system
that mathematically is impossible to solve by a direct numerical method.
The dimension problem is $m$ x $n$ x $N$, where $m$ x $n$ is
the interferogram dimension and $N$ is the number of interferograms.
For nonlinear systems, the iterative\emph{ }steepest-descent algorithm
can converge to local minimums if its parameters are set adequately
\cite{Nocedal}, but its converge speed results very slow in this case.
Then, we split the problem in two: the linear part and the nonlinear
part. The linear part are the equations that result by making zero
the following partials: $\frac{\partial U}{\partial\varphi(x,y)}$
and $\frac{\partial U}{\partial\psi(x,y)}$ , for all $(x,y)\in L$.
The nonlinear part are the equations that result by making zero the
following partial: $\frac{\partial U}{\partial\alpha_{k}}$, for $k=0,1,2,...,N-
1$.
Thus, to speed up the minimization process, our iterative minimization
strategy combines in each iteration the Gauss-Seidel update for the
linear part, and the steepest-descent update for the nonlinear part.
Then, the iterations of our minimization strategy are given with the
following updates: 

\begin{equation}
\varphi^{n+1}(x,y)=Solve\: for\:\varphi^{n}(x,y)\: Eq.\left[\frac{\partial U(
\varphi^{n}+i\psi^{n},\alpha^{n})}{\partial\varphi(x,y)}=0\right];\;\forall(x,y)
\in L
\end{equation}


\begin{equation}
\psi^{n+1}(x,y)=Solve\: for\:\psi^{n}(x,y)\: Eq.\left[\frac{\partial U(\varphi^{
n}+i\psi^{n},\alpha^{n})}{\partial\psi(x,y)}=0\right];\;\forall(x,y)\in L
\end{equation}


\begin{equation}
\alpha_{k}^{n+1}=\alpha_{k}^{n}-\mu\frac{\partial U(\varphi^{n}+i\psi^{n},
\alpha^{n})}{\partial\alpha_{k}},\: k=0,1,2,...,N-1.
\end{equation}
Equations (3.8) and (3.9) correspond to the Gauss-Seidel update, and equation
(3.10) is the steepest-descent update. In the next section, we show the explicit 
formulas of these equations.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Minimization process of the quadratic functional}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The iteration updates shown in Eqs. (3.8), (3.9) and (3.10) are given by
taking the gradient of (3.4) and solving in the following way:
\begin{equation}
\varphi^{n+1}(x,y)=\frac{F_{r}(\varphi^{n}+i\psi^{n},\alpha^{n})}{H_{r}(\alpha^{
n})}
\end{equation}


\begin{equation}
\psi^{n+1}(x,y)=\frac{F_{i}(\varphi^{n}+i\psi^{n},\alpha^{n})}{H_{i}(\alpha^{n})
}
\end{equation}
where

\begin{eqnarray}
F_{r}(\varphi^{n}+i\psi^{n},\alpha^{n}) & = & I_{0}(x,y)+\sum_{k=1}^{N-1}[I_{k}
cos(\alpha)-\psi(x,y)sin(\alpha_{k})cos(\alpha_{k})]\nonumber \\
 &  & +\lambda[\varphi(x-1,y)s(x-1,y)+\varphi(x+1,y)s(x+1,y)\\
 &  & +\varphi(x,y-1)s(x,y-1)+\varphi(x,y+1)s(x,y+1)],\nonumber 
\end{eqnarray}
\begin{eqnarray}
F_{i}(\varphi^{n}+i\psi^{n},\alpha^{n}) & = & \sum_{k=1}^{N-1}[I_{k}cos(\alpha)-
\varphi(x,y)sin(\alpha_{k})cos(\alpha_{k})]\nonumber \\
 &  & +\lambda[\psi(x-1,y)s(x-1,y)+\psi(x+1,y)s(x+1,y)\\
 &  & +\psi(x,y-1)s(x,y-1)+\psi(x,y+1)s(x,y+1)],\nonumber 
\end{eqnarray}


\begin{equation}
H_{r}(\alpha)=\sum_{k=1}^{N-1}cos^{2}(\alpha_{k})+\lambda[s(x-1,y)+s(x+1,y)+s(x,
y-1)+s(x,y+1)]
\end{equation}


\begin{equation}
H_{i}(\alpha)=\sum_{k=1}^{N-1}sin^{2}(\alpha_{k})+\lambda[s(x-1,y)+s(x+1,y)+s(x,
y-1)+s(x,y+1)]
\end{equation}
The function $s(x_{0},y_{0})$ is an indicator function that is 1
if the point $(x_{0},y_{0})$ is into the spatial domain of the interferograms,
otherwise it is zero. Now, for the steepest-descent update (the phase-shifts
$\alpha$) the iteration update is:
\begin{eqnarray}
\alpha_{0}^{n+1} & = & 0\\
\alpha_{k}^{n+1} & = & \alpha_{k}^{n}-\mu\sum_{\forall(x,y)\in L}[\varphi^{n}(x,
y)cos(\alpha_{k}^{n})+\psi^{n}(x,y)sin(\alpha_{k}^{n})-I_{k}(x,y)]\nonumber \\
 &  & [\psi^{n}(x,y)cos(\alpha_{k}^{n})-\varphi^{n}(x,y)sin(\alpha_{k}^{n})].
\end{eqnarray}
\textbf{Note:} suppose that $\alpha$ has the inter-frame phase-shifts
that minimize (3.4). Its negative values minimize (3.4) as well. Then,
while minimizing (3.4) it is possible obtain phase-shift values that
looks different to the actual phase-shift values. This is not a problem,
since we actually are interested in the modulating phase of the interferograms.
However, it is always worth fix the inter-frame phase-shifts obtained
in the following way:

\begin{equation}
\widehat{\alpha}_{k}=\begin{cases}
\widehat{\alpha}_{k} & if\;|\widehat{\alpha}_{k}-\widehat{\alpha}_{k-1}|<\pi\\
\widehat{\alpha}_{k}-2\pi &
if\;\widehat{\alpha}_{k}-\widehat{\alpha}_{k-1}>\pi\\
\widehat{\alpha}_{k}+2\pi & if\;\widehat{\alpha}_{k}-\widehat{\alpha}_{k-1}<-\pi
\end{cases}
\end{equation}
for $k=1,2,3...N-1$, in order to have our inter-frame
phase-shifts within the variation range($-\pi,\pi$).


\section{Numerical experiments and results}

To obtain the results presented here, the minimization process described
here made 1000 iterations to reach a relative convergence error of
$1.322\times10^{-4}$. This relative convergence error is calculated
as $\sqrt{\sum(\alpha_{k}^{n}-\alpha_{k}^{n+1})^{2}}$, where the
sum runs over $k=1,2,3,...N\text{\textminus}1$, $\alpha_{k}^{n}$
is the \emph{k}-phase-shift estimated in the current iteration and
$\alpha_{k}^{n+1}$ is the \emph{k}-phase-shift of the next iteration.
This minimization process, coded and compiled in C-language, took
a time of 11.310 seconds for these 512 \texttimes{} 512 interferogram
frames in a computer with a 8-cores CPU of 1.73GHz having 8GB of memory
RAM. The regularization parameter $\lambda$ (see Eq. (3.4)) was set
to $\lambda=10$, and the parameter $\mu$ of the steepest-descent
update was $\mu=\frac{1.2}{512\times512}$ (see Eq. (3.10)). Actually, choosing
$\mu=\frac{1.2}{512\times512}$ is a very good parameter for the steepest-descent
update of Eq. (3.10), where $m$ \texttimes{} $n$ is the dimension
of the interferogram frames. In our numerical experiments, we start
always the minimization process with initial values of $f=0$, and
$\alpha_{k}=k\frac{\pi}{2}$ for $k=0,1,2...,N\text{\textminus}1$.
The interferogram sequence was generated as follows: The \emph{k}-frame
is given as $I_{k}=b(x,y)cos(\phi(x,y)+\alpha_{k})+\eta(x,y)$, being
$\eta(x,y)$ a random field of white noise with mean $\gamma=0$ and
variance $\sigma^{2}=4.84$ radians. The modulation, or contrast term
$b(x,y)$, was modeled as a parabola centered at pixel $(256,256)$
of the image frames with a dynamic range between 1 and 3. The inter-frame
phase-shifts where generated as $\alpha_{k}=\pi+0.4*\varepsilon$
, where $\varepsilon_{k}$ is a random scalar with a uniform distribution
between $-\pi$ and $\pi$ radians. Here, we compare our results with
the so called Advanced Iterative Algorithm (AIA) presented in Ref.
\cite{Wang:04} because this method estimates the phase and inter-frame
phase-shifts as well, but using other approach.
\begin{table}
\begin{centering}
\begin{tabular}{|c|c|c|}
\hline 
Steps & Proposed Method & AIA Method\tabularnewline
\hline 
\hline 
0 & 0 & 0\tabularnewline
\hline 
1 & 0.0766 & 0.0904\tabularnewline
\hline 
2 & 0.0637 & 0.7146\tabularnewline
\hline 
3 & 0.0569 & 0.7083\tabularnewline
\hline 
4 & 0.0569 & 0.5520\tabularnewline
\hline 
\end{tabular}
\par\end{centering}

\caption{This table shows the error obtained between the phase-shift estimation
and the actual phase-shift.}
\end{table}
In Table. 1, we show the errors values of the estimated phase-shifts using our
regularized method and the estimated using the AIA method. This errors
are calculated as $|\alpha_{k} - \alpha_{k}|$,
where $\hat{\alpha}_{k}$ and $\alpha_{k}$ are the values of the
estimated and actual phase-shifts for the \emph{k}-frame, respectively.
There we can see that our method estimates the inter-frame phase-shifts
with less error. On the other hand, in Fig. 1, we show the interferogram 
sequence and the recovered phase. Fig.
1.(A) shows the recovered phase using the regularized self-tuning
demodulation method presented here, while Fig. 1.(B) shows the recovered
phase using the AIA method. We can see in this figure that our proposed
regularized self-tuning demodulation method recovers the phase with
less noise and error than with the AIA method. The errors shown in
Fig. 1.(A) and Fig. 1.(B) are calculated as standard deviation of
the difference between the recovered phase map and the true phase
map used to generate the interferograms.

\begin{figure}
\begin{centering}
\includegraphics[scale=0.2]{Chpt2_figures/Steps.eps}
\par\end{centering}

\caption{Interferogram sequence and the recovered phase. (A) shows the recovered
phase and error using the regularized self-tuning method proposed
here. (B) shows the recovered phase and error using the AIA method{[}15{]}.
The error shown (in radians) is the standard deviation respecting
the true phase map. The interferogram frames has a size of 512 \texttimes{}
512.}
\end{figure}

%%%%%%%%%%%%%%%%%%
\section{Conclusions}
%%%%%%%%%%%%%%%%%

We have presented a regularized self-tuning phase-shifting 
demodulation method for interferogram sequences having arbitrary variations of 
the inter-frame 
phase-shifts. This method is robust to non constant spatial modulations. As shown 
in the results, our demodulation method is able to filter-out noise, and recover 
the modulating phase and the inter-frame phase-shifts with a minimum error. The 
demodulation method presented here is a nonlinear demodulation method, however, 
we innovate the minimization strategy by mixing the steepest-descent update with 
the Gauss-Seidel update. In this way, we were able to speed up the minimization 
process and obtain the expected results.




%\bibliographystyle{plain}
%\bibliography{./References_PhdThesis}



%\begin{thebibliography}{99}

%\bibitem{Malacara}D. Malacara, M. Servin, and Z. Malacara,
%\textit{Interferogram Analysis for Optical Testing}(CRC, 2005), 2nd ed.

%\bibitem{Freischlad:90}K. Freischlad and C. L. Koliopoulos, "Fourier
%description of digital phase-measuring interferometry,"
%Journal of the Optical Society of America A 7, 542 (1990).

%\bibitem{Servin:09}M. Servin, J. C. Estrada, J. A. Quiroga, J. F. Mosino,
%and M. Cywiak, "Noise in phase shifting interferometry,"
%Opt. Express 17, 8789\textendash{}8794 (2009).

%\bibitem{Schwider:83} J. Schwider, R. Burow, K. E. Elssner, J. Grzanna,
%R. Spolaczyk, and K. Merkel, "Digital wave-front
%measuring interferometry: some systematic error sources."
%Applied optics 22, 3421 (1983).

%\bibitem{Ai:87}C. Ai and J. C. Wyant, "Effect of
%piezoelectric transducer nonlinearity on phase shift interferometry,"
%Appl. Opt. 26, 1112\textendash{}1116 (1987).

%\bibitem{Larkin:01}K. Larkin, \textquotedblleft{}A self-calibrating
%phase-shifting algorithm based on the natural demodulation of two-dimensional
%fringe patterns.\textquotedblright{} Optics express 9, 236\textendash{}253
%(2001).

%\bibitem{Cheng:85}Y.-Y. Cheng and J. C. Wyant, "Phase
%shifter calibration in phase-shifting interferometry,"
%Appl. Opt. 24, 3049\textendash{} 3052 (1985).

%\bibitem{Hariharan:87} P. Hariharan, B. F. Oreb, and T. Eiju,
%\textquotedblleft{} Digital phase-shifting interferometry: a simple
%error-compensating phase calculation algorithm,\textquotedblright{} Appl. Opt.
%26, 2504\textendash{}2506 (1987).

%\bibitem{Surrel:93} Y. Surrel, \textquotedblleft{}Phase stepping: a new
%self-calibrating algorithm.\textquotedblright{} Applied optics 32,
%3598\textendash{}3600 (1993).

%\bibitem{Estrada:09} J. C. Estrada, M. Servin, and J. A. Quiroga,
%\textquotedblleft{} Easy and straightforward construction of wideband
%phase-shifting algorithms for interferometry,\textquotedblright{} Opt. Lett.
%34, 413\textendash{}415 (2009).

%\bibitem{Lai:91}G. Lai and T. Yatagai, \textquotedblleft{}Generalized
%phase-shifting interferometry,\textquotedblright{} J. Opt. Soc. Am.
%A 8, 822\textendash{}827 (1991).

%\bibitem{Kong} I.-B. Kong, \textquotedblleft{}General algorithm
%of phase-shifting interferometry by iterative least-squares
%fitting,\textquotedblright{}
%Opt. Eng. 34, 183 (1995).

%\bibitem{Wang:04} Z. Wang and B. Han, \textquotedblleft{}Advanced iterative
%algorithm for phase extraction of randomly phase-shifted interferograms.\
%textquotedblright{} Optics letters 29, 1671\textendash{}3 (2004).

%\bibitem{Estrada:10} Julio C. Estrada, M. Servin, and J. A. Quiroga,
%\textquotedblleft{}A self-tuning phase-shifting algorithm for
%interferometry,\textquotedblright{} Opt. Express 18, 2632\textendash{}2638
%(2010).

%\bibitem{Larkin:02} K. G. Larkin, D. J. Bone, and M. a. Oldfield,
%\textquotedblleft{}Natural demodulation of two-dimensional fringe patterns. I.
%General background of the spiral phase quadrature
%transform.\textquotedblright{} J Opt Soc Am A Opt Image Sci Vis 18,
%1862\textendash{}70 (2001).

%\bibitem{RQF} J. L. Marroquin, J. E. Figueroa, and M. Servin,
%\textquotedblleft{}Robust
%quadrature filters,\textquotedblright{} Journal of the Optical Society
%of America A 14, 779 (1997).

%\bibitem{AQF_mult} J. L. Marroquin, M. Servin, and R. Rodriguez Vera,
%\textquotedblleft{}Adaptive quadrature filters for multiple phase-stepping
%images.\textquotedblright{} Optics letters 23, 238\textendash{}40
%(1998).

%\bibitem{Jahne} B. Jahne, Digital Image Processing (Springer, 2005).

%\bibitem{Nocedal} J. Nocedal and S. JW, Numerical Optimization, Operations
%Research (Springer, 2006).

%\bibitem{a22} Orlando Medina and Julio C. Estrada. Source code
%for Matlab, https://sites.google.com/site/juliocestradarico/academic-notes/
%source-code01

%\end{thebibliography}
